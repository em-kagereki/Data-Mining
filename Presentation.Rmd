---
title: "Explainable artificial intelligence model to predict mortality in patients
   with suspected acute coronary syndrome"
subtitle: "MIMIC III ANALYSIS"
author: "Edwin Kagereki"
institute: ""
date: "2021/09/20 (Presented: `r Sys.Date()`)"

output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "style.css"]
    lib_dir: libs
    nature:
      fig_crop: no
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
      
---

```{r xaringan-themer, include=FALSE, warning=FALSE, message=FALSE}
library(xaringanthemer)
# https://pkg.garrickadenbuie.com/xaringanthemer/articles/xaringanthemer.html
style_solarized_light(text_color = "#657b83", header_color = "#268bd2",
  background_color = "#fdf6e3", link_color = "#b58900",
  text_bold_color = "#d33682", text_slide_number_color = "#93a1a1",
  padding = "1em 4em 1em 4em", background_image = NA,
  background_size = NA, background_position = NA,
  code_highlight_color = "#268bd240", code_inline_color = "#6c71c4",
  code_inline_background_color = NA, code_inline_font_size = "1em",
  inverse_background_color = "#002b36", inverse_text_color = "#fdf6e3",
  inverse_text_shadow = FALSE, inverse_header_color = "#fdf6e3",
  title_slide_text_color = "#fdf6e3",
  title_slide_background_color = "#002b36",
  title_slide_background_image = NA, title_slide_background_size = NA,
  title_slide_background_position = NA, footnote_color = NA,
  footnote_font_size = "0.7em", footnote_position_bottom = "1em",
  left_column_subtle_color = "#93a1a1",
  left_column_selected_color = "#586e75",
  blockquote_left_border_color = "#cb4b16", table_border_color = "#839496",
  table_row_border_color = "#839496",
  table_row_even_background_color = "#eee8d5", text_font_size = "20px",
  header_h1_font_size = "55px", header_h2_font_size = "45px",
  header_h3_font_size = "35px", text_slide_number_font_size = "0.9em",
  #text_font_google = NULL, text_font_family = "'Droid Serif'",
  text_font_weight = "normal",
  #text_font_url = "https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic",
  #text_font_family_fallback = "'Palatino Linotype', 'Book Antiqua', Palatino, 'Microsoft YaHei', 'Songti SC'",
  text_font_base = "serif", header_font_google = NULL,
 # header_font_family = "'Yanone Kaffeesatz'", header_font_weight = "normal",
  #header_font_url = "https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz",
  #code_font_google = NULL, code_font_family = "'Source Code Pro'",
  code_font_size = "0.9em",
  #code_font_url = "https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700",
  code_font_family_fallback = "'Lucida Console', Monaco", extra_css = NULL,
  extra_fonts = NULL, outfile = "xaringan-themer.css")


```


# Outline

 - Back ground
 - Data Understanding
 - Data Preparation
 - Modeling
 - Evaluation
 - Deployment

---
# Acute Coronary Syndrome (ACS) 

- Cardiovascular diseases (CVDs) are the leading cause of global mortality.
- Prediction of prognosis model for patients with suspected ACS is important in critical care medicine.
- Syndromes Suggestive of Ischemia or Infarction is a term given to diverse presentations related to cardiomyopathies of sudden onset.

- commonly used in the diagnosis of acute coronary syndrome and the related differential diagnosis include:

*"stemi","acute coronary syndrome","angina","tachycardia","aortic aneurysm","pericardi","ortic dissection","coronary artery dissection","cardiomyopathy","heart failure","mitral valve disease","mitral stenosis","coronary artery disease","chf","congestive heart failure","heart failure","telemetry","myocardial infaction","cardiac arrest","myocardial infarction","aortic stenosis","st elevated","pericardial effusion", "cardiomyopathy","cath lab","tamponade","tamponede"*


---
# Proactively making clinical decisions.
- Prediction of risk for untoward outcomes may help clinicians chose the type and intensity of therapy.

```{r, echo=FALSE, out.width=800, out.height=430,fig.align="center"}
#knitr::include_graphics("Hnet.com-image.PNG")
knitr::include_graphics("workflow1.PNG")

```


.footnote[[*]  [ACLS guideline](https://www.acls.net/images/algo-acs.pdf)]

---

---
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
ggplot(diamonds) +
  aes(cut, fill = cut) +
  geom_bar(show.legend = FALSE) +
  labs(
    x = "Cut",
    y = "Count",
    title = "A Fancy diamonds Plot"
  ) +
  theme_xaringan(background_color = "#FFFFFF") +
  scale_xaringan_fill_discrete()
```

---
# MIMIC-III database

- Freely-available database comprising deidentified health related data from 46,520 patients who stayed in critical care units of the Beth Israel Deaconess Medical Center between 2001 and 2012.

- Pre-requisite for data access:
1. Become a credentialed user on PhysioNet after completion of a training course in human
subjects research.
2. Sign the data data usage agreement.

- All data was collected downloaded  to  PostgreSQL database. 

- Loinc data tables were used to enrich the data. [Loinc tables](https://loinc.org/downloads/)]

---

## Objectives

The aim of the project was:

 - Build a binary classification machine learning model to predict all-cause mortality of patients based on demographics and interventions within first hour of suspected ACS event.
 
- Assess and report any work flow variations between patients who died and those who
survived.

This was achieved by:

- This project aims at developing a risk-prediction tool for ACS, focusing on clinical end point of all-cause
mortality after one hour of treatment(golden hour) using machine learning classification algorithm.
- Explanation of the predicted outcome based on the care pathway using process mining. This AHA guideline(ACLS 2020) will was used as the gold standard for ACS workflow`*`.

.footnote[[*]  [ACLS guideline](https://www.acls.net/images/algo-acs.pdf)]

---
# Data Mining

- Data exploration.
- Data pre-processing
- Model building and tuning
- Process mining.
---
class: full
# Data access

- After connecting to the PostgreSQL database,  SQL queries were made using the R dplyr interface. The following tables were collected:


---
# Summary of study population
# Distribution of admissions over time

```{r, echo=FALSE,message=FALSE,warning=FALSE}

## https://exploratory.io/note/kanaugust/How-to-Create-Table-1-Summary-Information-YYf5BPf4Xs
#source("summaryStats.R")

#source("Step2_EDA.R")
#source("Table1.R")
#trial2

```

---

```{r, echo = FALSE,out.height="80%",out.width="80%", warning = FALSE,message=FALSE}

#source("Step2_EDA.R")
#ggplot(dataPlot1, aes(x = year, y = n)) + 
#  geom_line(aes(color = status), size = 1) +
#  ggtitle("From 2100 to 2190 (Full Data Set)") +
#  xlab("Year(shifted)") + ylab("Number of admissions")+
#  theme_xaringan(background_color = "#fdf6e3",text_font_size = 12,title_font_size =18) 


```

---

class: full

```{r, fig.asp = 3/4, fig.align = 'center', echo = FALSE, out.width = "100%", dpi= 300, warning = FALSE}
#https://pkg.garrickadenbuie.com/xaringanthemer/reference/theme_xaringan.html

library(ggplot2)
library(palmerpenguins)

ggplot(penguins) +
  aes(bill_length_mm, bill_depth_mm,
      color = species) +
  geom_point() +
  theme_minimal() +
  theme_xaringan(background_color = "#fdf6e3",text_font_size = 12,title_font_size =18) +
 # scale_xaringan_fill_discrete() +
  labs(title = "Bill depth and length")
```
---

# Diagnosis

```{r}
# http://loiyumba.github.io/2016-08-01-eurocup2016vis/
```

---
class: full

# Derived

Some considerations were done
.pull-left[
Age
1. Computed by subtracting the *DOB* from the *ADMITTIME*.

2. Values above 300 was adjusted by subtracting 211.
]

.pull-right[
Datetime Features

1. Day of the year;

2. Week of the year;

3. Month;

4. Year

5. Hour of the day;

]

---

# Categorical variable encoding

Some considerations were done
.pull-left[
Variables with high cardinality
1. Diagnosis.

2. Medication.

]

.pull-right[
Variables with less cardinality but need to preserve the variance
1. Language;

2. Tribe;

]

.footnote[[*] Not really. See next page.]

Final dataset had
---
# Dimension reduction


---
# Selection number of components



---
# Modeling

The following candidate models were chosen with the vanila methods

- Logistic Regression
- Random Forest,
- XGBoost (extreme gradient boosted trees),
- K-nearest neighbor
- Artificial Neural network(ANN)

Now we can use our validation set (k folds) to estimate the performance of our models using the fit_resamples() function to fit the models on each of the folds and store the results.

- The metrics used were

---

# Chosen model

The best model was:

---
class: full

# Model tuning

```{r, echo = FALSE,out.height="80%",out.width="80%", warning = FALSE,message=FALSE}
setwd("E:/school/data mining/project/mimic-iii-clinical-database-1.4/mimic-iii-clinical-database-1.4/codes")

library(dplyr)
finalMetrics <- read.csv("final_metrics.csv", h=T, sep=',') %>% 
  filter(.metric == "f_meas")
ggplot(finalMetrics) +
  geom_point(aes(x = mean, y = model,color = model))+
  theme_xaringan(background_color = "#fdf6e3",text_font_size = 12,title_font_size =18) +
 # scale_xaringan_fill_discrete() +
  labs(title = "Bill depth and length")
```


---

# Determining the most appropriate cut-off value


---
# Selected model 


---
class: full
# Processes

```{r, echo = FALSE,out.height="80%",out.width="80%", warning = FALSE,message=FALSE}
setwd("E:/school/data mining/project/mimic-iii-clinical-database-1.4/mimic-iii-clinical-database-1.4/codes")

source("processMining.R")
Process_Map

```
---

class: center

# Hand seals (Âç∞)

Press `h` or `?` to see the possible ninjutsu you can use in remark.js.

![](https://upload.wikimedia.org/wikipedia/commons/7/7e/Mudra-Naruto-KageBunshin.svg)

---

class: center, middle

# Thanks!

Slides created via the R package [**xaringan**](https://github.com/yihui/xaringan).

The chakra comes from [remark.js](https://remarkjs.com), [**knitr**](https://yihui.org/knitr/), and [R Markdown](https://rmarkdown.rstudio.com).